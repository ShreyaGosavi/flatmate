generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CHAT MODELS
// ============================================
model Conversation {
  id             String    @id @default(cuid())
  participant1Id String
  participant2Id String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  participant1  User      @relation("ConversationParticipant1", fields: [participant1Id], references: [id], onDelete: Cascade)
  participant2  User      @relation("ConversationParticipant2", fields: [participant2Id], references: [id], onDelete: Cascade)
  messages      Message[]

  @@unique([participant1Id, participant2Id])  // one conversation per pair of users
  @@index([participant1Id])
  @@index([participant2Id])
  @@index([updatedAt])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  text           String
  createdAt      DateTime     @default(now())

  conversation  Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender        User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
}

// ============================================
// COMMUNITY NOTICEBOARD MODELS
// ============================================

model Community {
  id              String            @id @default(cuid())
  name            String
  type            CommunityType
  city            String
  officialWebsite String?
  email           String?
  ctgId           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  members  CommunityMember[]
  notices  Notice[]

  @@unique([name, city])
  @@index([city])
  @@index([name])
  @@index([type])
}

model CommunityMember {
  id          String    @id @default(cuid())
  userId      String
  communityId String
  joinedAt    DateTime  @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
  @@index([communityId])
  @@index([userId])
}

model CommunityRequest {
  id              String        @id @default(cuid())
  requestedById   String
  communityName   String
  type            CommunityType
  city            String
  officialWebsite String?
  email           String?
  ctgId           String?
  status          RequestStatus @default(PENDING)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  requestedBy User @relation(fields: [requestedById], references: [id], onDelete: Cascade)

  @@unique([communityName, city])
  @@index([requestedById])
  @@index([status])
}

model Notice {
  id          String     @id @default(cuid())
  communityId String
  postedById  String
  type        NoticeType
  title       String
  description String
  metadata    Json?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  postedBy  User      @relation(fields: [postedById], references: [id], onDelete: Cascade)

  @@index([communityId])
  @@index([communityId, type])
  @@index([createdAt])
  @@index([isActive])
  @@index([postedById])
}

// ============================================
// PROPERTY MODELS
// ============================================

model Property {
  id                 String                     @id @default(cuid())
  title              String
  description        String
  propertyType       PropertyType
  rent               Int
  deposit            Int
  maintenance        Int
  isAvailable        Boolean                    @default(true)
  sharing            Int
  genderPreference   Gender
  bhk                BHK
  suitableFitFor     String?
  addressLine1       String
  addressLine2       String?
  locality           String
  city               String
  district           String
  state              String
  country            String
  postalCode         String
  latitude           Decimal                    @db.Decimal(10, 8)
  longitude          Decimal                    @db.Decimal(11, 8)
  formattedAddress   String?
  placeId            String?                    @unique
  ownerId            String
  visitingHrs        String?
  ownershipProof     String?
  verifiedAt         DateTime?
  amenities          AmenityType[]
  rules              Json?
  images             String[]
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt
  verificationStatus PropertyVerificationStatus @default(PENDING)
  User               User                       @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  PropertyStats      PropertyStats?
  SavedProperty      SavedProperty[]

  @@index([bhk])
  @@index([city, locality])
  @@index([city, propertyType, rent, isAvailable])
  @@index([createdAt])
  @@index([genderPreference])
  @@index([isAvailable])
  @@index([latitude, longitude])
  @@index([ownerId])
  @@index([propertyType])
  @@index([rent])
}

model PropertyStats {
  id         String   @id @default(cuid())
  propertyId String   @unique
  viewCount  Int      @default(0)
  saveCount  Int      @default(0)
  Property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([saveCount])
  @@index([viewCount])
}

model SavedProperty {
  id         String   @id @default(cuid())
  userId     String
  propertyId String
  savedAt    DateTime @default(now())
  Property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, propertyId])
  @@index([propertyId])
  @@index([savedAt])
  @@index([userId])
}
// ============================================
// USERS MODELS
// ============================================

model User {
  id              String          @id @default(cuid())
  email           String          @unique
  passwordHash    String
  username        String          @unique
  phone           String
  gender          Gender
  isEmailVerified Boolean         @default(false)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  isAdmin         Boolean         @default(false)
  Property        Property[]
  SavedProperty   SavedProperty[]
  CommunityMember  CommunityMember[]
  CommunityRequest CommunityRequest[]
  Notice           Notice[]
  ConversationsAsP1 Conversation[] @relation("ConversationParticipant1")
  ConversationsAsP2 Conversation[] @relation("ConversationParticipant2")
  Message           Message[]


  @@index([email])
  @@index([username])
}

// ============================================
// ENUMS
// ============================================

enum AmenityType {
  WIFI
  AC
  PARKING
  LAUNDRY
  GYM
  POWER_BACKUP
  WATER_SUPPLY
  FURNISHED_BED
  ATTACHED_BATHROOM
  SECURITY
  CCTV
  LIFT
  PURIFIER
  OTHERS
}

enum BHK {
  ONE_BHK
  TWO_BHK
  THREE_BHK
  FOUR_BHK
  ONE_RK
}

enum Gender {
  MALE
  FEMALE
}

enum PropertyType {
  HOSTEL
  PG
  APARTMENT
  OTHER
}

enum PropertyVerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum NoticeType {
  ROOMMATE_NEEDED
  SPARE_ITEM_GIVEAWAY
}

enum CommunityType {
  COLLEGE
  COMPANY
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}